@model TimetableSystem.Models.BPRViewModel
@{
    ViewBag.Title = "Availability";
}
<script type="text/javascript">
    $(document).ready(function () {
        refreshTable();
        //Set Park field change function
        $('#Park').change(function () {
            refreshTable();
            var queryLink = '@Url.Action("parkSelected")';
            $.get(queryLink, { parkName: $(this).val() }, function (data) {
                var temp = data.split('!');
                var buildings = temp[0].split(';');
                var rooms = temp[1].split(';');
                $b = $('#Building');
                $b.empty();
                $b.append("<option>No Preference</option>");
                $r = $('#Room');
                $r.empty();
                $r.append("<option>No Preference</option>");
                for (var i = 0; i < buildings.length; i++) {
                    $b.append("<option>" + buildings[i] + "</option>");
                }
                for (var k = 0; k < rooms.length; k++) {
                    $r.append("<option>" + rooms[k] + "</option>");
                }
            });
        });
        //Set Building field change function
        $('#Building').change(function () {
            refreshTable();
            var queryLink = '@Url.Action("buildingSelected")';
            $.get(queryLink, { buildingName: $(this).val() }, function (data) {
                var rooms = data.split(';');
                $r = $('#Room');
                $r.empty();
                $r.append("<option>No Preference</option>");
                for (var k = 0; k < rooms.length; k++) {
                    $r.append("<option>" + rooms[k] + "</option>");
                }
            });
        });
        $('#Room').change(function () {
            refreshTable();
        });
    });

    //Function to print the table based on current form data
    function refreshTable() {
        //Form values
        var park = $('#Park').val();
        var building = $('#Building').val();
        var room = $('#Room').val().split(' ')[0];
        var semester = $('#Semester').val();
        var week = $('#Week').val();

        var titleHtml = "<h2>Showing availability for ";

        if (room != "No" && room != "") {
            titleHtml += "room " + room + " for week " + week + ", semester " + semester;
        } else if (building != "No Preference" && building != "") {
            titleHtml += "building " + building + " for week " + week + ", semester " + semester;
        } else if (park != "No Preference" && park != "") {
            titleHtml += park + " park for week " + week + ", semester " + semester;
        } else { titleHtml += "all parks/buildings/rooms for week " + week + ", semester " + semester; }

        titleHtml += "</h2>";
        $('#subtitleDiv').html(titleHtml);

        //GET call to "getAvailability" function, which returns corresponding html string to print table
        $.get('@Url.Action("getAvailability")', { parkName: park, buildingName: building, roomCode: room,
            semester: semester, week: week
        }, function (data) {
            $('#tableDiv').html(data);
        });
    }
    
</script>
<h2>Availability</h2>

@*Park, Building, Room, Week*@
@{ string[] filters = {"Semester", "Park", "Building", "Room", "Week"};}

@using (Html.BeginForm())
{
    @Html.ValidationSummary(true)
    
    <fieldset>
        <legend>Filters</legend>

            <div class="editor-label">
                @Html.Label("Semester")
            </div>
            <div class="editor-field">
                @Html.DropDownList("Semester", (IEnumerable<SelectListItem>)ViewData["Semester"])
                @Html.ValidationMessage("Semester", "Semester is mandatory")
            </div>

            <div class="editor-label">
                @Html.Label("Park")
            </div>
            <div class="editor-field">
                @Html.DropDownList("Park", (IEnumerable<SelectListItem>)ViewData["Park"], "No Preference")
            </div>

            <div class="editor-label">
                @Html.Label("Building")
            </div>
            <div class="editor-field">
                @Html.DropDownList("Building", (IEnumerable<SelectListItem>)ViewData["Building"], "No Preference")
            </div>

            <div class="editor-label">
                @Html.Label("Room")
            </div>
            <div class="editor-field">
                @Html.DropDownList("Room", (IEnumerable<SelectListItem>)ViewData["Room"], "No Preference")
            </div>

            <div class="editor-label">
                @Html.Label("Week")
            </div>
            <div class="editor-field">
                @Html.DropDownList("Week", (IEnumerable<SelectListItem>)ViewData["Week"])
            </div>

    </fieldset>
}
<div id="subtitleDiv">

</div>

<div id="tableDiv">
        
</div>

   